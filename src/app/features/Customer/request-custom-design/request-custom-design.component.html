<div class="custom-design-container">
    <div *ngIf="loading" class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>
  
    <div *ngIf="error" class="error-message">
      {{ error }}
      <button class="back-btn" (click)="goToPortfolio()">Back to Portfolio</button>
    </div>
  
    <!-- Success Message -->
    <div *ngIf="submitSuccess" class="success-message">
      <h2>Design Request Submitted Successfully!</h2>
      <p>Your custom design request has been submitted. Our team will review your requirements and start working on it.</p>
      <div class="order-summary">
        <p><strong>Order ID:</strong> #{{ orderResponse.orderId }}</p>
        <p><strong>Status:</strong> {{ orderResponse.orderStatus }}</p>
        <p><strong>Estimated Price:</strong> Rs.{{ orderResponse.totalPrice }}</p>
      </div>
      <div class="action-buttons">
        <button class="primary-btn" (click)="goToOrderDetails()">View Order Details</button>
        <button class="secondary-btn" routerLink="/my-orders">View All Orders</button>
      </div>
    </div>
  
    <!-- Custom Design Request Form -->
    <div *ngIf="!loading && !error && !submitSuccess" class="custom-design-content">
      <div class="custom-design-header">
        <button class="back-btn" (click)="goToPortfolio()">
          ‚Üê Back to Portfolio
        </button>
        <h1>Request Custom Design</h1>
        <p class="header-desc">Tell us about your dream backdrop, and our designers will create it for you</p>
      </div>
  
      <form [formGroup]="customRequestForm" (ngSubmit)="onSubmit()">
        <div class="form-section">
          <h2>Basic Information</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="customName">Name for Celebration</label>
              <input 
                type="text" 
                id="customName" 
                formControlName="customName" 
                [ngClass]="{'invalid': customRequestForm.get('customName')?.touched && customRequestForm.get('customName')?.invalid}"
              >
              <div *ngIf="customRequestForm.get('customName')?.touched && customRequestForm.get('customName')?.invalid" class="error-text">
                <span *ngIf="customRequestForm.get('customName')?.errors?.['required']">Name is required</span>
                <span *ngIf="customRequestForm.get('customName')?.errors?.['maxlength']">Name cannot exceed 50 characters</span>
              </div>
            </div>
  
            <div class="form-group">
              <label for="customAge">Age</label>
              <input 
                type="number" 
                id="customAge" 
                formControlName="customAge" 
                [ngClass]="{'invalid': customRequestForm.get('customAge')?.touched && customRequestForm.get('customAge')?.invalid}"
              >
              <div *ngIf="customRequestForm.get('customAge')?.touched && customRequestForm.get('customAge')?.invalid" class="error-text">
                <span *ngIf="customRequestForm.get('customAge')?.errors?.['required']">Age is required</span>
                <span *ngIf="customRequestForm.get('customAge')?.errors?.['min']">Age cannot be negative</span>
                <span *ngIf="customRequestForm.get('customAge')?.errors?.['max']">Age cannot exceed 150</span>
              </div>
            </div>
          </div>
  
          <div class="form-group">
            <label for="eventDate">Event Date</label>
            <input 
              type="date" 
              id="eventDate" 
              formControlName="eventDate" 
              [ngClass]="{'invalid': customRequestForm.get('eventDate')?.touched && customRequestForm.get('eventDate')?.invalid}"
            >
            <div *ngIf="customRequestForm.get('eventDate')?.touched && customRequestForm.get('eventDate')?.invalid" class="error-text">
              <span *ngIf="customRequestForm.get('eventDate')?.errors?.['required']">Event date is required</span>
            </div>
          </div>
  
          <div class="form-group">
            <label for="deliveryAddress">Delivery Address</label>
            <textarea 
              id="deliveryAddress" 
              formControlName="deliveryAddress" 
              rows="3"
              [ngClass]="{'invalid': customRequestForm.get('deliveryAddress')?.touched && customRequestForm.get('deliveryAddress')?.invalid}"
            ></textarea>
            <div *ngIf="customRequestForm.get('deliveryAddress')?.touched && customRequestForm.get('deliveryAddress')?.invalid" class="error-text">
              <span *ngIf="customRequestForm.get('deliveryAddress')?.errors?.['required']">Delivery address is required</span>
              <span *ngIf="customRequestForm.get('deliveryAddress')?.errors?.['maxlength']">Address cannot exceed 200 characters</span>
            </div>
          </div>
        </div>
  
        <div class="form-section">
          <h2>Design Details</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="themeName">Theme Name</label>
              <input 
                type="text" 
                id="themeName" 
                formControlName="themeName" 
                placeholder="e.g., Fairy Tale, Superhero, Safari"
                [ngClass]="{'invalid': customRequestForm.get('themeName')?.touched && customRequestForm.get('themeName')?.invalid}"
              >
              <div *ngIf="customRequestForm.get('themeName')?.touched && customRequestForm.get('themeName')?.invalid" class="error-text">
                <span *ngIf="customRequestForm.get('themeName')?.errors?.['required']">Theme name is required</span>
              </div>
            </div>
  
            <div class="form-group">
              <label for="themeColor">Theme Color (Optional)</label>
              <input 
                type="text" 
                id="themeColor" 
                formControlName="themeColor" 
                placeholder="e.g., Blue, Pink, Gold"
              >
            </div>
          </div>
  
          <div class="form-group">
            <label for="conceptDescription">Concept Description</label>
            <textarea 
              id="conceptDescription" 
              formControlName="conceptDescription" 
              rows="4"
              placeholder="Describe what you envision for your backdrop design"
              [ngClass]="{'invalid': customRequestForm.get('conceptDescription')?.touched && customRequestForm.get('conceptDescription')?.invalid}"
            ></textarea>
            <div *ngIf="customRequestForm.get('conceptDescription')?.touched && customRequestForm.get('conceptDescription')?.invalid" class="error-text">
              <span *ngIf="customRequestForm.get('conceptDescription')?.errors?.['required']">Concept description is required</span>
            </div>
          </div>
        </div>
  
        <div class="form-section">
          <h2>Inspiration Images</h2>
          <p class="section-desc">Upload images that inspire you or represent what you're looking for</p>
          
          <div class="image-upload-section">
            <div class="upload-box">
              <input type="file" id="inspirationImages" (change)="onInspirationImagesChange($event)" accept="image/*" multiple>
              <label for="inspirationImages" class="upload-label">
                <div class="upload-icon">üì∑</div>
                <span>Choose Images</span>
              </label>
            </div>
            
            <div *ngIf="inspirationPreviewUrls.length > 0" class="image-previews">
              <div *ngFor="let previewUrl of inspirationPreviewUrls; let i = index" class="image-preview-card">
                <img [src]="previewUrl" alt="Inspiration Image">
                <button type="button" class="remove-image-btn" (click)="removeInspirationImage(i)">√ó</button>
              </div>
            </div>
          </div>
        </div>
  
        <div class="form-section">
          <h2>Items</h2>
          <p class="section-desc">Select items from our catalog or add custom items for your design</p>
          
          <div class="items-section">
            <div class="catalog-items">
              <h3>Add Items from Catalog</h3>
              
              <div class="search-box">
                <input 
                  type="text" 
                  placeholder="Search items..." 
                  [(ngModel)]="searchQuery" 
                  (input)="filterItems()"
                  [ngModelOptions]="{standalone: true}"
                >
              </div>
              
              <div *ngIf="itemsLoading" class="items-loading">
                <div class="spinner-small"></div>
                <span>Loading items...</span>
              </div>
              
              <div *ngIf="!itemsLoading" class="items-list">
                <div *ngFor="let item of filteredItems" class="item-option" (click)="addCatalogItem(item)">
                  <div class="item-details">
                    <span class="item-name">{{ item.name }}</span>
                    <span class="item-price">Rs.{{ item.unitPrice }}</span>
                  </div>
                  <button type="button" class="add-btn">Add</button>
                </div>
                
                <div *ngIf="filteredItems.length === 0" class="no-items">
                  No items found matching your search.
                </div>
              </div>
            </div>
            
            <div class="selected-items">
              <div class="selected-header">
                <h3>Selected Items</h3>
                <button type="button" class="add-custom-btn" (click)="addCustomItem()">+ Add Custom Item</button>
              </div>
              
              <div *ngIf="customItems.length === 0" class="no-selected-items">
                No items selected yet. Add items from the catalog or create custom items.
              </div>
              
              <div *ngIf="customItems.length > 0" class="custom-items-list">
                <div *ngFor="let itemControl of customItems.controls; let i = index" class="custom-item-card">
                  <!-- Using *ngIf to check type rather than setting formGroup directly -->
                  <div class="item-header">
                    <ng-container *ngIf="itemControl.get('itemType')?.value === 'catalog'">
                      <h4>{{ itemControl.get('name')?.value }}</h4>
                    </ng-container>
                    
                    <ng-container *ngIf="itemControl.get('itemType')?.value === 'custom'">
                      <input 
                        type="text" 
                        [formControl]="$any(itemControl.get('customItemName'))" 
                        placeholder="Custom Item Name"
                        [ngClass]="{'invalid': itemControl.get('customItemName')?.touched && itemControl.get('customItemName')?.invalid}"
                      >
                      <div *ngIf="itemControl.get('customItemName')?.touched && itemControl.get('customItemName')?.invalid" class="error-text">
                        <span *ngIf="itemControl.get('customItemName')?.errors?.['required']">Name is required</span>
                      </div>
                    </ng-container>
                    
                    <button type="button" class="remove-item-btn" (click)="removeItem(i)">√ó</button>
                  </div>
                  
                  <div class="item-content">
                    <div class="item-details">
                      <div *ngIf="itemControl.get('itemType')?.value === 'catalog'" class="item-price">
                        <span>Rs.{{ itemControl.get('price')?.value }} each</span>
                      </div>
                      
                      <div *ngIf="itemControl.get('itemType')?.value === 'custom'" class="custom-description">
                        <textarea 
                          [formControl]="$any(itemControl.get('description'))"
                          placeholder="Describe this custom item"
                          rows="2"
                          [ngClass]="{'invalid': itemControl.get('description')?.touched && itemControl.get('description')?.invalid}"
                        ></textarea>
                        <div *ngIf="itemControl.get('description')?.touched && itemControl.get('description')?.invalid" class="error-text">
                          <span *ngIf="itemControl.get('description')?.errors?.['required']">Description is required</span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="item-quantity">
                      <label>Quantity:</label>
                      <input 
                        type="number" 
                        [formControl]="$any(itemControl.get('quantity'))"
                        min="1"
                        [ngClass]="{'invalid': itemControl.get('quantity')?.touched && itemControl.get('quantity')?.invalid}"
                      >
                      <div *ngIf="itemControl.get('quantity')?.touched && itemControl.get('quantity')?.invalid" class="error-text">
                        <span *ngIf="itemControl.get('quantity')?.errors?.['required']">Quantity is required</span>
                        <span *ngIf="itemControl.get('quantity')?.errors?.['min']">Minimum quantity is 1</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
  
        <div class="order-summary-section">
          <h2>Order Summary</h2>
          <div class="price-estimation">
            <span class="estimation-label">Estimated Price:</span>
            <span class="estimation-value">Rs.{{ calculateTotalPrice() }}</span>
            <p class="estimation-note">Final price will be confirmed after review by our design team</p>
          </div>
        </div>
  
        <div *ngIf="submitError" class="error-message">
          {{ submitError }}
        </div>
  
        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="goToPortfolio()">Cancel</button>
          <button 
            type="submit" 
            class="submit-btn" 
            [disabled]="submitLoading || imageUploading || customRequestForm.invalid"
          >
            <span *ngIf="submitLoading || imageUploading">
              <div class="spinner-small"></div> Processing...
            </span>
            <span *ngIf="!submitLoading && !imageUploading">Submit Request</span>
          </button>
        </div>
      </form>
    </div>
  </div>