<h2 mat-dialog-title>Order Details - #{{ order.orderNumber }}</h2>

<mat-dialog-content>
  <div class="order-details">
    <!-- Progress Timeline -->
    <div class="progress-timeline">
      <h3>Order Progress</h3>
      <div class="timeline">
        <div *ngFor="let step of getStatusSteps(); let i = index" class="timeline-step"
          [class.completed]="step.completed" [class.active]="step.active" [class.pending]="step.pending"
          [class.cancelled]="step.isCancelled">
          <div class="step-icon">
            <mat-icon>{{ step.icon }}</mat-icon>
          </div>
          <div class="step-content">
            <h4>{{ step.label }}</h4>
            <p *ngIf="step.date" class="step-date">{{ formatDate(step.date) }}</p>
            <p *ngIf="step.cancellationReason" class="cancellation-reason">
              Reason: {{ step.cancellationReason }}
            </p>
            <p *ngIf="step.message" class="step-message">{{ step.message }}</p>

            <div class="payment-rejection-alert" *ngIf="hasRejectedPayment()">
              <mat-icon color="warn">error</mat-icon>
              <strong>Payment Rejected</strong>
              <p>{{ getRejectionReason() }}</p>
              <p>Please contact your bank or try a different payment method.</p>

              <!-- Show specific installment details if it's an installment rejection -->
              <div *ngIf="hasRejectedInstallmentPayment()" class="installment-rejection-details">
                <p class="rejection-amount">Amount: Rs. {{ getRejectedPaymentAmount() | number:'1.2-2' }}</p>
              </div>
            </div>

            <!-- Installment specific details -->
            <div *ngIf="step.installmentDetails" class="installment-details">
              <span class="installment-amount">{{ step.installmentDetails.percentage }}% (Rs. {{
                step.installmentDetails.amount | number:'1.2-2' }})</span>
              <mat-chip *ngIf="step.installmentDetails.status"
                [color]="getInstallmentChipColor(step.installmentDetails.status)" selected>
                {{ getInstallmentStatusText(step.installmentDetails.status) }}
              </mat-chip>
            </div>
          </div>
          <div *ngIf="i < getStatusSteps().length - 1" class="step-connector"></div>
        </div>
      </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Payment Summary Section (when applicable) -->
    <div class="payment-summary"
      *ngIf="paymentSummary && (paymentSummary.totalPaid > 0 || order.paymentStatus !== 'pending')">
      <h3>Payment Summary</h3>
      <div class="info-grid">
        <div class="info-item">
          <label>Total Amount</label>
          <p>Rs. {{ order.totalPrice | number:'1.2-2' }}</p>
        </div>
        <div class="info-item">
          <label>Paid Amount</label>
          <p [class.text-success]="paymentSummary.isFullyPaid">
            Rs. {{ paymentSummary.totalPaid | number:'1.2-2' }}
            <mat-icon *ngIf="paymentSummary.isFullyPaid" class="icon-success">check_circle</mat-icon>
          </p>
        </div>
        <div class="info-item" *ngIf="!paymentSummary.isFullyPaid">
          <label>Remaining Amount</label>
          <p class="text-warning">Rs. {{ paymentSummary.remainingAmount | number:'1.2-2' }}</p>
        </div>
        <div class="info-item" *ngIf="order.installmentPlanId && order.installmentTotalInstallments">
          <label>Installment Plan</label>
          <p>{{ order.currentInstallmentNumber || 1 }} of {{ order.installmentTotalInstallments }}</p>
        </div>
        <div class="info-item full-width" *ngIf="!paymentSummary.isFullyPaid && paymentSummary.deadlineDate">
          <label>Payment Deadline</label>
          <p class="deadline-warning">
            <mat-icon color="warn">schedule</mat-icon>
            Full payment required by {{ formatDate(paymentSummary.deadlineDate) }}
          </p>
        </div>
      </div>
    </div>

    <mat-divider
      *ngIf="paymentSummary && (paymentSummary.totalPaid > 0 || order.paymentStatus !== 'pending')"></mat-divider>

    <!-- Order Information -->
    <div class="order-info">
      <h3>Order Information</h3>
      <div class="info-grid">
        <div class="info-item">
          <label>Order Type</label>
          <p>{{ order.orderType === 'as-is' ? 'Standard Design' : (order.orderType === 'custom-design' ? 'Custom Design'
            : 'Custom Request') }}</p>
        </div>
        <div class="info-item">
          <label>Created On</label>
          <p>{{ formatDate(order.createdAt) }}</p>
        </div>
        <div class="info-item">
          <label>Base Price</label>
          <p *ngIf="order.basePrice">Rs. {{ order.basePrice | number:'1.2-2' }}</p>
          <p *ngIf="!order.basePrice" class="loading-text">Loading price...</p>
        </div>
        <div class="info-item" *ngIf="order.transportationCost">
          <label>Transportation Cost</label>
          <p>Rs. {{ order.transportationCost }}</p>
        </div>
        <div class="info-item" *ngIf="order.additionalRentalCost">
          <label>Additional Rental Cost</label>
          <p>Rs. {{ order.additionalRentalCost }}</p>
        </div>
        <div class="info-item" *ngIf="order.totalPrice">
          <label>Total Price</label>
          <p><strong>Rs. {{ order.totalPrice }}</strong></p>
        </div>
      </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Event Details -->
    <div class="event-details">
      <h3>Event Details</h3>
      <div class="info-grid">
        <div class="info-item">
          <label>Name</label>
          <p>{{ order.customDetails.customName }}</p>
        </div>
        <div class="info-item">
          <label>Age/Year</label>
          <p>{{ order.customDetails.customAge }}</p>
        </div>
        <div class="info-item">
          <label>Event Category</label>
          <p>{{ categoryName || 'Loading...' }}</p>
        </div>
        <div class="info-item">
          <label>Date</label>
          <p>{{ order.customDetails.eventDate | date:'fullDate' }}</p>
        </div>
        <div class="info-item">
          <label>Time</label>
          <p>{{ formatTime(order.customDetails.eventTime) }}</p>
        </div>
        <div class="info-item full-width">
          <label>Venue</label>
          <p>{{ order.customDetails.venue }}</p>
        </div>
      </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Customer Information -->
    <div class="customer-info">
      <h3>Customer Information</h3>
      <div class="info-grid">
        <div class="info-item">
          <label>Name</label>
          <p>{{ order.customerInfo.firstName }} {{ order.customerInfo.lastName }}</p>
        </div>
        <div class="info-item">
          <label>Email</label>
          <p>{{ order.customerInfo.email }}</p>
        </div>
        <div class="info-item">
          <label>Contact</label>
          <p>{{ order.customerInfo.contact }}</p>
        </div>
        <div class="info-item">
          <label>Relationship</label>
          <p>{{ formatRelationship(order.customerInfo.relationshipToPerson) }}</p>
        </div>
      </div>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="dialogRef.close()">Close</button>

  <!-- Payment History Button - always show if there are payments -->
  <button mat-stroked-button color="primary" *ngIf="shouldShowPaymentHistoryButton()"
    (click)="openPaymentHistoryDialog()">
    <mat-icon>history</mat-icon>
    Payment History
  </button>

  <!-- Make Payment Button - only show if order needs payment -->
  <button mat-raised-button color="primary" *ngIf="shouldShowMakePaymentButton()" (click)="openPaymentDialog()">
    <mat-icon>payment</mat-icon>
    Make Payment
  </button>
</mat-dialog-actions>